#!/bin/bash
BASH_PATH=/tmp/Hais/ReplaceFile
configFile='/sdcard/.hais'
if [ ! -d $configFile ];then touch $configFile;fi
source $configFile		#导入变量

#删除多余文件
busybox rm -rf /system_root/lost+found
busybox rm -rf /cache/lost+found
busybox rm -rf /data/lost+found
busybox rm -rf /data/magisk_backup_*
busybox rm -rf /mnt/vendor/persist/lost+found
rm -rf /system_root/lost+found
rm -rf /cache/lost+found
rm -rf /data/lost+found
rm -rf /data/magisk_backup_*
rm -rf /mnt/vendor/persist/lost+found

#判断是否去除缓存
oldMd5=`md5sum -b "/data/.hais" | cut -d" " -f1`
newMd5=`md5sum -b "$configFile" | cut -d" " -f1`
if [ "$oldMd5" != "$newMd5" ] || [ "$delCache" == "YES" ] ;then 
	echo '开始删除缓存，开机后重新编译'
	rm -rf /data/dalvik-cache
	rm -rf /data/system/package_cache
fi



#替换system所有文件
repType=system
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	

#替换vendor所有文件
repType=vendor
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	
	

#替换cust所有文件
repType=cust
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	

#替换data所有文件
repType=data
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	
	
#关闭日记
echo "关闭桌面日记"
home=/data/user_de/0/com.miui.home/cache/debug_log
if [ -e $home/* ] ;then
	rm -rf $home/*
	chmod 000 $home
	busybox chattr +i $home
	echo " "
	echo "已关闭Miui桌面日志"
fi


	
#备份配置文件
cp $configFile /data/
