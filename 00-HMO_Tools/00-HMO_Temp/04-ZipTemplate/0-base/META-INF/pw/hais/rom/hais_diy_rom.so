#!/bin/bash
BASH_PATH=/tmp/Hais/ReplaceFile

#删除多余文件
busybox rm -rf /system_root/lost+found
busybox rm -rf /cache/lost+found
busybox rm -rf /data/lost+found
busybox rm -rf /data/magisk_backup_*
busybox rm -rf /mnt/vendor/persist/lost+found
busybox rm -rf /data/dalvik-cache
busybox rm -rf /data/system/package_cache


#替换system所有文件
repType=system
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	

#替换vendor所有文件
repType=vendor
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	
	

#替换cust所有文件
repType=cust
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	

#替换data所有文件
repType=data
for file in `find $BASH_PATH/${repType}_files/* -type f`
	do
		tmpPath=${file%/*}									#刷机包中的路径
		sysfile=${repType}${file##*${repType}_files}	#准备要替换或增加的目标文件
		sysPath=${sysfile%/*}					#准备要替换或增加的文件
		echo "- 备份并替换 $file"
		echo "mkdir -p /$sysPath"
		echo "cp  $file /$sysfile"
		echo "chmod 644 /$sysfile"
		mkdir -p /$sysPath					#创建目标目录 /system/app/Via/
		cp  $file /$sysfile					#替换文件
		chmod 644 /$sysfile					#修复权限
	done
	
	
echo "关闭桌面日记"
home=/data/user_de/0/com.miui.home/cache/debug_log
busybox chattr -i $home
rm -rf $home
mkdir -p $home
#chmod 000 $home
#busybox chattr +i $home	#不可读会导致界面不可保存
	


#调用自定义apk文件
haisConfig='/sdcard/HaisConfig.sh'
if [ -n "$haisConfig" ];then 
	source $haisConfig		#导入变量
	if [ -n "$backFiles" ];then
		mkdir -p "${BASH_PATH}/backFiles"
		unzip -d "${BASH_PATH}/backFiles" "$backFiles"		#解压扩展文件
		busybox sh "${BASH_PATH}/backFiles/hais_diy_rom.so" "$haisConfig" | tee -a "${BASH_PATH}/backFiles.log"	#运行扩展脚本
	fi
	if [ -n "$extFiles" ];then
		mkdir -p "${BASH_PATH}/extFiles"
		unzip -d "${BASH_PATH}/extFiles" "$extFiles"		#解压扩展文件
		busybox sh "${BASH_PATH}/extFiles/hais_diy_rom.so" "$haisConfig" | tee -a "${BASH_PATH}/extFiles.log"	#运行扩展脚本
	fi
fi
